#!/usr/bin/env python3

import os
import sys
import glob
import string
import argparse
import subprocess
import re
from collections import defaultdict
from pathlib import Path


def get_valid_boards(arduino_dir):
    boardstxt_path = next(arduino_dir.glob("**/hardware/arduino/avr/boards.txt"))
    bt = defaultdict(list)

    name_expression = re.compile(r"^([\w\d_\-]+)\.name.*$")
    sub_expression = re.compile(r"^([\w\d_\-]+)\.menu\.(?:cpu|chip)\.([\w\d_\-]+)=.*$")

    for line in boardstxt_path.open():
        name_match = name_expression.match(line)
        sub_match = sub_expression.match(line)

        if name_match is not None:
            board = name_match.group(1)

            if not board in bt:
                bt[board] = []

        if sub_match is not None:
            board, sub = (sub_match.group(1), sub_match.group(2))
            bt[board].append(sub)

    return bt


def git_hash():
    """Return first four characters of the hash"""
    hash = subprocess.getoutput("git rev-parse --short HEAD")
    return hash[:4]


if __name__ == "__main__":
    parser = argparse.ArgumentParser()

    parser.add_argument("--arduino-dir", type=Path,
            default=Path("/usr/share/arduino"),
            help="Root of the Arduino distribution")
    parser.add_argument("--ardmk-dir", type=Path,
            default=Path("./libs/Arduino-Makefile").absolute(),
            help="Path to the location of Arduino.mk")
    parser.add_argument("--avr-tools-dir", type=Path,
            default=Path("/usr"),
            help="Path to the AVR tools directory")
    parser.add_argument("--avrdude-conf", type=Path,
            default=Path("/etc/avrdude.conf"),
            help="Path to avrdude.conf")
    parser.add_argument("--user-lib-path", type=Path,
            default=Path("./libs").absolute(),
            help="Path to the user libs dir")
    parser.add_argument("--with-ds18b20", type=int,
            help="Use DS18B20 temperature sensor at the given pin")
    parser.add_argument("board", help="Name of the board")

    args = parser.parse_args()

    AVRDUDE_CONF = args.avrdude_conf
    VERSION_STRING = git_hash()

    boards_dict = get_valid_boards(args.arduino_dir)
    board = args.board.split('.', 1)
    BOARD_TAG, *rest = args.board.split(".")
    BOARD_SUB = rest[0] if rest else ""

    if not BOARD_TAG in boards_dict:
        raise ValueError(f"Unknown board '{BOARD_TAG}'.\nValid boards: {', '.join(boards_dict.keys())}")

    subs = boards_dict[BOARD_TAG]

    if subs and not BOARD_SUB:
        raise ValueError(f"Board '{BOARD_TAG}' has subtypes. Use <BOARD_TAG>.<BOARD_SUB> with valid subtype: {', '.join(subs)}")

    if BOARD_SUB:
        if not subs:
            raise ValueError(f"Board '{BOARD_TAG}' has no subtypes.")

        if not BOARD_SUB in subs:
            raise ValueError(f"Unknown board subtype '{BOARD_SUB}'.\nValid subtypes for '{BOARD_TAG}': {', '.join(subs)}")

    ARDUINO_LIBS = []
    CONFIG = []

    if args.with_ds18b20 is not None:
        ARDUINO_LIBS.append("OneWire")
        ARDUINO_LIBS.append("DallasTemperature")
        CONFIG.append("#define WITH_DS18B20 1")
        CONFIG.append(f"#define DS18B20_PIN {args.with_ds18b20}")

    with Path("Makefile").open("w") as f:
        template = string.Template(open("Makefile.in").read())

        d = dict(ARDUINO_DIR=args.arduino_dir,
                 ARDUINO_LIBS=" ".join(ARDUINO_LIBS),
                 ARDMK_DIR=args.ardmk_dir,
                 AVR_TOOLS_DIR=args.avr_tools_dir,
                 AVRDUDE_CONF=AVRDUDE_CONF,
                 BOARD_TAG=BOARD_TAG,
                 BOARD_SUB=BOARD_SUB,
                 ARDMK_LOCATION=args.ardmk_dir / "Arduino.mk",
                 USER_LIB_PATH=args.user_lib_path)

        f.write(template.safe_substitute(d))

    with Path("config.h").open("w") as f:
        template = string.Template(open("config.h.in").read())
        d = dict(VERSION_STRING=VERSION_STRING)
        f.write(template.safe_substitute(d))
        f.write("\n".join(CONFIG))
        f.write("\n")
